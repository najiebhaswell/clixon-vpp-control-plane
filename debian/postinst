#!/bin/bash
set -e

PACKAGE="clixon-vpp"
PREFIX="/opt/clixon-vpp"

case "$1" in
    configure)
        echo "Configuring $PACKAGE..."
        
        # Create clixon group if not exists
        if ! getent group clixon > /dev/null 2>&1; then
            groupadd -r clixon
            echo "Created 'clixon' group"
        fi
        
        # Create clixon user if not exists
        if ! getent passwd clixon > /dev/null 2>&1; then
            useradd -r -g clixon -d /var/lib/clixon -s /usr/sbin/nologin -c "Clixon daemon" clixon
            echo "Created 'clixon' user"
        fi
        
        # Set permissions
        chown -R root:clixon /var/lib/clixon
        chmod 775 /var/lib/clixon/vpp
        
        # Update library cache
        echo "$PREFIX/lib" > /etc/ld.so.conf.d/clixon-vpp.conf
        ldconfig
        
        # Create symlink for config if not exists
        if [ ! -f /etc/clixon/clixon-vpp.xml ] && [ -f $PREFIX/etc/clixon-vpp.xml ]; then
            ln -sf $PREFIX/etc/clixon-vpp.xml /etc/clixon/clixon-vpp.xml
        fi
        
        # Reload systemd
        systemctl daemon-reload || true
        
        echo ""
        echo "=============================================="
        echo "  $PACKAGE installed successfully!"
        echo "=============================================="
        echo ""
        echo "To start the services:"
        echo "  sudo systemctl start clixon-vpp-backend"
        echo "  sudo systemctl start clixon-vpp-restconf"
        echo ""
        echo "To enable on boot:"
        echo "  sudo systemctl enable clixon-vpp-backend"
        echo "  sudo systemctl enable clixon-vpp-restconf"
        echo ""
        echo "To use CLI:"
        echo "  clixon_cli -f /etc/clixon/clixon-vpp.xml"
        echo ""
        ;;
    abort-upgrade|abort-remove|abort-deconfigure)
        ;;
    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

exit 0
