#!/usr/bin/make -f

export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

PACKAGE = clixon-vpp
PREFIX = /opt/clixon-vpp
BUILD_DIR = $(CURDIR)/build-tmp
CLIGEN_DIR = $(BUILD_DIR)/cligen
CLIXON_DIR = $(BUILD_DIR)/clixon

%:
	dh $@

override_dh_auto_clean:
	rm -rf $(BUILD_DIR)
	rm -f src/*.o *.so
	dh_auto_clean

override_dh_auto_configure:
	@echo "=== Preparing build environment ==="
	mkdir -p $(BUILD_DIR)

override_dh_auto_build:
	@echo "=== Building CLIgen ==="
	cd $(BUILD_DIR) && \
		git clone --depth 1 https://github.com/clicon/cligen.git && \
		cd cligen && \
		./configure --prefix=$(PREFIX) && \
		$(MAKE) -j$$(nproc)
	
	@echo "=== Building Clixon ==="
	cd $(BUILD_DIR) && \
		git clone --depth 1 https://github.com/clicon/clixon.git && \
		cd clixon && \
		./configure \
			--prefix=$(PREFIX) \
			--with-cligen=$(CLIGEN_DIR) \
			--with-restconf=native \
			--enable-netconf-monitoring \
			--sysconfdir=/etc && \
		$(MAKE) -j$$(nproc)
	
	@echo "=== Building VPP Plugin ==="
	PKG_CONFIG_PATH=$(CLIGEN_DIR):$(CLIXON_DIR) \
	CFLAGS="-I$(CLIGEN_DIR)/lib -I$(CLIXON_DIR)/lib -I$(CLIXON_DIR)/include" \
	LDFLAGS="-L$(CLIGEN_DIR)/lib/.libs -L$(CLIXON_DIR)/lib/.libs" \
	$(MAKE) -C $(CURDIR) \
		CLIXON_CFLAGS="-I$(CLIXON_DIR)/lib -I$(CLIXON_DIR)/include -I$(CLIGEN_DIR)/lib" \
		CLIXON_LIBS="-L$(CLIXON_DIR)/lib/.libs -L$(CLIGEN_DIR)/lib/.libs -lclixon -lcligen" \
		clean all || true

override_dh_auto_install:
	@echo "=== Installing to debian package ==="
	# Create directory structure
	mkdir -p $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/bin
	mkdir -p $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/sbin
	mkdir -p $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/lib
	mkdir -p $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/lib/clixon/plugins/backend
	mkdir -p $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/lib/clixon/plugins/cli
	mkdir -p $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/lib/clixon/plugins/restconf
	mkdir -p $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/share/clixon
	mkdir -p $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/share/clixon/cli
	mkdir -p $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/etc
	mkdir -p $(CURDIR)/debian/$(PACKAGE)/etc/clixon
	mkdir -p $(CURDIR)/debian/$(PACKAGE)/etc/clixon/vpp.d
	mkdir -p $(CURDIR)/debian/$(PACKAGE)/var/lib/clixon/vpp
	mkdir -p $(CURDIR)/debian/$(PACKAGE)/usr/local/bin
	mkdir -p $(CURDIR)/debian/$(PACKAGE)/usr/local/sbin
	mkdir -p $(CURDIR)/debian/$(PACKAGE)/usr/local/lib
	
	# Install CLIgen
	cd $(CLIGEN_DIR) && $(MAKE) DESTDIR=$(CURDIR)/debian/$(PACKAGE) prefix=$(PREFIX) install
	
	# Install Clixon
	cd $(CLIXON_DIR) && $(MAKE) DESTDIR=$(CURDIR)/debian/$(PACKAGE) prefix=$(PREFIX) sysconfdir=/etc install
	
	# Install VPP plugins
	if [ -f $(CURDIR)/vpp_plugin.so ]; then \
		install -m 755 $(CURDIR)/vpp_plugin.so $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/lib/clixon/plugins/backend/; \
	fi
	if [ -f $(CURDIR)/vpp_backend.so ]; then \
		install -m 755 $(CURDIR)/vpp_backend.so $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/lib/clixon/plugins/backend/; \
	fi
	if [ -f $(CURDIR)/vpp_cli.so ]; then \
		install -m 755 $(CURDIR)/vpp_cli.so $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/lib/clixon/plugins/cli/; \
	fi
	
	# Install YANG models
	install -m 644 $(CURDIR)/yang/*.yang $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/share/clixon/
	
	# Install CLI specs
	install -m 644 $(CURDIR)/cli/*.cli $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/share/clixon/cli/ 2>/dev/null || true
	
	# Install configuration
	install -m 644 $(CURDIR)/config/clixon-vpp.xml $(CURDIR)/debian/$(PACKAGE)/etc/clixon/
	
	# Install helper scripts
	install -m 755 $(CURDIR)/scripts/*.sh $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/bin/ 2>/dev/null || true
	
	# Create symlinks to /usr/local for convenience
	ln -sf $(PREFIX)/bin/clixon_cli $(CURDIR)/debian/$(PACKAGE)/usr/local/bin/clixon_cli
	ln -sf $(PREFIX)/sbin/clixon_backend $(CURDIR)/debian/$(PACKAGE)/usr/local/sbin/clixon_backend
	ln -sf $(PREFIX)/sbin/clixon_restconf $(CURDIR)/debian/$(PACKAGE)/usr/local/sbin/clixon_restconf
	ln -sf $(PREFIX)/sbin/clixon_netconf $(CURDIR)/debian/$(PACKAGE)/usr/local/sbin/clixon_netconf
	
	# Create library symlinks
	for lib in $(CURDIR)/debian/$(PACKAGE)$(PREFIX)/lib/*.so*; do \
		if [ -f "$$lib" ]; then \
			libname=$$(basename $$lib); \
			ln -sf $(PREFIX)/lib/$$libname $(CURDIR)/debian/$(PACKAGE)/usr/local/lib/$$libname 2>/dev/null || true; \
		fi; \
	done

override_dh_shlibdeps:
	dh_shlibdeps -l$(CURDIR)/debian/$(PACKAGE)$(PREFIX)/lib

override_dh_strip:
	dh_strip --no-automatic-dbgsym
